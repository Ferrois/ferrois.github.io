<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://kit.fontawesome.com/ae5fff5f87.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="pong_index.css">
  <script type="module" defer>
  	///////////////////////////////////////////////////////////////////////////////////
	// TODO: Add SDKs for Firebase products that you want to use
	// https://firebase.google.com/docs/web/setup#available-libraries
	// Your web app's Firebase configuration
	// For Firebase JS SDK v7.20.0 and later, measurementId is optional
	import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
	import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
	import { getDatabase, set, ref, push, child, get} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";


	const firebaseConfig = {
		apiKey: "AIzaSyBUvKHCJKAjQdywhtKHM2bL9MAj7f6rOXw",
		authDomain: "ferrois-project.firebaseapp.com",
		databaseURL: "https://ferrois-project-default-rtdb.asia-southeast1.firebasedatabase.app",
		projectId: "ferrois-project",
		storageBucket: "ferrois-project.appspot.com",
		messagingSenderId: "238913088786",
		appId: "1:238913088786:web:3667527b33fc457d2997cb",
		measurementId: "G-N6ZV5Y740J"
	};
		
		// Initialize Firebase
		const firebase = initializeApp(firebaseConfig);
		const analytics = getAnalytics(firebase);
		const database = getDatabase(firebase);
	
	// startScreen
	var roomCode;
	var usernameId = null;
	var submitName = document.querySelector(".submitName");
	var typeName = document.querySelector(".typeName");
	var joinRoom = document.querySelector(".joinRoomBtn");
	var typeRoom = document.querySelector(".gameRoom");
	var newRoom = document.querySelector(".createRoomBtn");
	//public room
	submitName.addEventListener("click",()=>{
		if (typeName.value.length < 3 || typeName.value.length > 12){
			alert("Please pick a name from 3 to 12 characters")
			typeName.value = "";
		}else{
			// declare roomcode
			roomCode = "public";
			// update roomcode heading
			document.querySelector(".panel").innerHTML = `<b> Room Code : ${roomCode} </b>`;
			//declare username
			usernameId = typeName.value;
			// remove startscreen
			document.querySelector(".startScreen").classList.add("startScreenOver");
			setTimeout(initiateChat,1000);
		}
	});
	//private room join
	joinRoom.addEventListener("click",()=>{
		if (typeName.value.length < 3 || typeName.value.length > 12){
			alert("Please pick a name from 3 to 12 characters")
			typeName.value = "";
		}else{
			get(ref(database,"/private")).then((snapshot)=>{
				if(snapshot.child(typeRoom.value).exists()){
					alert(`Connected to ${typeRoom.value}`);
					roomCode = typeRoom.value;
					// update roomcode heading
					document.querySelector(".panel").innerHTML = `<b> Room Code : ${roomCode} </b>`;
					//declare username
					usernameId = typeName.value;
					// remove startscreen
					document.querySelector(".startScreen").classList.add("startScreenOver");
					setTimeout(initiateChat,1000);
				}else{
					alert("Invalid Code")
				}
			});
			// declare roomcode
		}
	});
	
	function generateUnusedCode(){
		var randomNumber = Math.floor(Math.random()*99999);
		get(ref(database,"/private")).then((snapshot)=>{
			if (snapshot.child(randomNumber+"").exists() == true){
				generateUnusedCode();
				return
			}else{
				
			}
		});
		return randomNumber;
	}
	
	
	
	newRoom.addEventListener("click",()=>{
		if (typeName.value.length < 3 || typeName.value.length > 12){
			alert("Please pick a name from 3 to 12 characters")
			typeName.value = "";
		}else{
			roomCode = generateUnusedCode();
			//REQUIRES ASYNC AWAIT
			alert(`Room Created, Code : ${roomCode}`)
			
			set(ref(database,`/private/${roomCode}`),{
				roomCreated : "true"
			});
			document.querySelector(".panel").innerHTML = `<b> Room Code : ${roomCode} </b>`;
			//declare username
			usernameId = typeName.value;
			// remove startscreen
			document.querySelector(".startScreen").classList.add("startScreenOver");
			setTimeout(initiateChat,1000);
		}
	});
	
	
//	document.querySelector(".panel").innerHTML = `<b> Room Code : ${roomCode} </b>`;
		
	//Chat system//////////
	var chatIcon = document.querySelector(".chatIcon");
	var chatSlider = document.querySelector(".chatSlider");
	var typeText = document.querySelector(".typeText");
	var sendText = document.querySelector(".sendText");
	var chatSliderActiveIndex = false;
	var isEnemy;
	var isHost,logInPlayerCount;
	isHost = true;
	
	function renderMessage(name,message){
		if (name == usernameId){
			var chatbox_wrapper = document.createElement("div");
			chatbox_wrapper.classList.add("myChatBoxWrapper");
		}else{
			var chatbox_wrapper = document.createElement("div");
			chatbox_wrapper.classList.add("ChatBoxWrapper");
		}
		chatbox_wrapper.innerHTML = `<p class="myChatBox"> ${name}: <br/> ${message} </p>`;
		document.querySelector(".chattingWrapper").appendChild(chatbox_wrapper);
	}
	
	var newCount = 0;
	var chatMsg,chatName;
	
	function defineCounts(){
		get(ref(database,`/private/${roomCode}/messages/count`)).then((snapshot)=>{
			newCount = snapshot.val();
			oldCount = snapshot.val()
		});
	}
	
	function checkMessages(){
		get(ref(database,`/private/${roomCode}/messages/count`)).then((snapshot)=>{
			newCount = snapshot.val();
		});
		if (newCount > oldCount){
			oldCount = newCount;
			console.log(newCount);
			console.log(oldCount);
			get(ref(database,`/private/${roomCode}/messages/${newCount}`)).then((snapshots)=>{
				chatMsg = snapshots.val().message;
				chatName = snapshots.val().name;
				renderMessage(chatName,chatMsg);
			})
			get(ref(database,`/private/${roomCode}/messages/count`)).then((snapshot)=>{
				oldCount = snapshot.val();
			});
		}else{
			
		}
	};
	
	
	var messageCount = 0;
	
	function initiateChat(){
		defineCounts();
		messageUpdators();
		setTimeout(()=>{
			for (let i = 1; i < (messageCount+1) ;i++){
				get(ref(database,`/private/${roomCode}/messages/${i}`)).then((snapshot)=>{
						chatMsg = snapshot.val().message;
						chatName = snapshot.val().name;
						renderMessage(chatName,chatMsg);
				});
			}
		},100)
	}
	
	chatIcon.addEventListener("click",()=>{
		if (chatSliderActiveIndex != true){
			chatSliderActiveIndex = true;
			chatSlider.classList.remove("isHidden");
			chatSlider.classList.add("isActive");
		}else{
			chatSliderActiveIndex = false;
			chatSlider.classList.remove("isActive");
			chatSlider.classList.add("isHidden");
		}
	});
	
	function updateMessageCount(){
		get(ref(database,`/private/${roomCode}/messages/count`)).then((snapshot)=>{
			messageCount = snapshot.val();
			if (messageCount == null){
				messageCount = 0;
			}
		});
	}
	function messageUpdators(){
		updateMessageCount();
		checkMessages();
		setInterval(()=>{
			updateMessageCount();
			checkMessages();
		},1000)
	}
	function sendMessage(){
		var message = typeText.value;
		if (message != ""){
			set(ref(database, `private/${roomCode}/messages` + `/${messageCount+1}`),{
				"name" : usernameId,
				"message" : message,
		//		"messageCount" : messageCount
			});
			document.querySelector(".typeText").value = "";
			set(ref(database, `private/${roomCode}/messages/count`),messageCount+1);
		}
	}
	sendText.addEventListener("click",sendMessage);
	

	
	
	//Game
	
	var canvas = document.querySelector(".canvas");
	var ctx = canvas.getContext("2d");
	canvas.width = 0.7 * innerWidth;
	canvas.height = 1.2 * innerWidth;
	
	if (screen.height / screen.width <= 2){
		canvas.height = 0.7 * innerHeight;
		canvas.width = 0.7/1.2 * canvas.height;
	}
	
	
	
	const joystick_big = document.querySelector(".joystickBig");
	const joystick_small = document.querySelector(".joystickSmall");
	
	var isJoystickActivated = false;
	
	var joystickPos = {
		x : 0,
		y : 0
	};
	
	var joystickOffset = joystick_big.getBoundingClientRect();
	var originalJoystickPos = {
		x :joystickOffset.width/2 - joystick_small.getBoundingClientRect().width/2 + joystickOffset.left,
		y :joystickOffset.height/2 - joystick_small.getBoundingClientRect().height/2 + joystickOffset.top
	};
	
		var trueJoystickPos = {
			x :  originalJoystickPos.x + joystickPos.x,
			y :  originalJoystickPos.y + joystickPos.y
		};
	
	function distChecker(){
		var distJoystick = Math.sqrt(Math.pow((clientMouseX - originalJoystickPos.x),2) + Math.pow((clientMouseY - originalJoystickPos.y),2));
	}
	function refreshPage(){
		ctx.rect(0,0,canvas.width,canvas.height)
		ctx.fillStyle = "rgba(55,55,55,1)";
		ctx.fill()
	}
	//Page Ticker
	function ticker(){
		requestAnimationFrame(ticker);
		refreshPage();
		//Joystick Controls
		trueJoystickPos.x = originalJoystickPos.x + joystickPos.x,
		trueJoystickPos.y = originalJoystickPos.y + joystickPos.y
		joystick_small.style.top = trueJoystickPos.y+"px";
		joystick_small.style.left = trueJoystickPos.x+"px";
		try{
			mainPlayer.updateJoystick();
		}catch(err){
		}
		//Paddle Controls
		try{
			if (isHost == true){
				mainPaddle.control();
				enemyPaddle.draw();
			}else{
				enemyPaddle.control();
				mainPaddle.draw();
			}
		}catch(err){
		}
		//Ball control
		try{
			ball.update();
		}catch(err){
		}
		
	};
	ticker();
	
	
	var oldCount = messageCount; ///////
	
	window.ontouchstart = e => {
		var distJoystick = Math.hypot((e.touches[0].clientX - (originalJoystickPos.x + joystick_small.getBoundingClientRect().width/2)),(e.touches[0].clientY - (originalJoystickPos.y + joystick_small.getBoundingClientRect().height/2)))
		if (distJoystick < joystickOffset.width/2){
			isJoystickActivated = true;
			joystickPos.x = e.touches[0].clientX - ( joystickOffset.left + joystickOffset.width/2 );//- joystick_small.getBoundingClientRect().width);
			joystickPos.y = e.touches[0].clientY - ( joystickOffset.top + joystickOffset.height/2 );
		}
	}
	
	window.ontouchmove = e => {
	//	joystickPos.x = e.touches[0].clientX - ( joystickOffset.left + joystickOffset.width/2 );//- joystick_small.getBoundingClientRect().width);
	//	joystickPos.y = e.touches[0].clientY - ( joystickOffset.top + joystickOffset.height/2 );
		if (isJoystickActivated == true){
			var distJoystick = Math.hypot((e.touches[0].clientX - (originalJoystickPos.x + joystick_small.getBoundingClientRect().width/2)),(e.touches[0].clientY - (originalJoystickPos.y + joystick_small.getBoundingClientRect().height/2)));
			if (distJoystick < joystickOffset.width/2){
			joystickPos.x = e.touches[0].clientX - ( joystickOffset.left + joystickOffset.width/2 );//- joystick_small.getBoundingClientRect().width);
			joystickPos.y = e.touches[0].clientY - ( joystickOffset.top + joystickOffset.height/2 );
			}else{
				let ratioDist = distJoystick / (joystickOffset.width/2);
				joystickPos.x = (e.touches[0].clientX - ( joystickOffset.left + joystickOffset.width/2 ))/ratioDist;
				joystickPos.y = (e.touches[0].clientY - ( joystickOffset.top + joystickOffset.height/2 ))/ratioDist;
		
			}
			//console.log(distJoystick)
		}
	}
	window.ontouchend = e =>{
		isJoystickActivated = false;
		joystickPos = {
			x : 0,
			y : 0
		}
	}
	var gridsInX = 140;
	var gridsInY = gridsInX * (canvas.height/canvas.width); //240
	var _grid = canvas.width / gridsInX;
	
	class Paddle{
		constructor(x1,x2,y1,y2,color,speed){
			this.x1 = x1 * _grid;
			this.x2 = x2 * _grid;
			this.y1 = y1 * _grid;
			this.y2 = y2 * _grid;
			this.color = color;
			this.paddleSpeed = speed;
		}
		draw(){
			ctx.beginPath();
			ctx.rect(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1);
			ctx.fillStyle = this.color;
			ctx.fill()
		}
		control(){
			if (joystickPos.x > 0 && this.x2 < gridsInX * _grid){
				this.x1 += 1 * this.paddleSpeed;
				this.x2 += 1 * this.paddleSpeed;
			}
			else if (joystickPos.x < 0 && this.x1 > 0){
				this.x1 += -1 * this.paddleSpeed;
				this.x2 += -1 * this.paddleSpeed;
			}else{
				
			}
			this.draw();
		}
	}
	var mainPaddle = new Paddle(60,80,225,230,"white",4);
	var enemyPaddle = new Paddle(60,80,10,15,"white",4);
	
	class Ball{
		constructor(x1,x2,y1,y2,velocity_x,velocity_y,speed){
			this.x1 = x1 * _grid;
			this.x2 = x2 * _grid;
			this.y1 = y1 * _grid;
			this.y2 = y2 * _grid;
			this.velocity_x = velocity_x * _grid;
			this.velocity_y = velocity_y * _grid;
			this.speed = speed;
		}
		//triggerBounce(){
			
	//	}
	//	triggerBounceWall(){
			
	//	}
		draw(){
			ctx.beginPath();
			ctx.rect(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1);
			ctx.fillStyle = "white";
			ctx.fill();
		}
		update(){
			this.testCollision()
			this.x1 += this.velocity_x * this.speed;
			this.x2 += this.velocity_x * this.speed;
			this.y1 += this.velocity_y * this.speed;
			this.y2 += this.velocity_y * this.speed;
			this.draw();
		}
		testCollision(){
			if (this.y2 > mainPaddle.y1 && this.y1 < mainPaddle.y2 && this.x2 > mainPaddle.x1 && this.x1 < mainPaddle.x2){
				if (this.velocity_y >= 0){
				this.velocity_y *= -1;
				}
			} //right wall
			if (this.y1 < enemyPaddle.y2 && this.y2 > enemyPaddle.y1 && this.x2 > enemyPaddle.x1 && this.x1 < enemyPaddle.x2){
				if (this.velocity_y <= 0){
				this.velocity_y *= -1;
				}
			} //
			else if (this.x2 > gridsInX*_grid && this.velocity_x > 0){
				this.velocity_x *= -1;
			}
			else if (this.x1 < 0 && this.velocity_x < 0){
				this.velocity_x *= -1;
			}
			else if (this.y2 > gridsInY*_grid || this.y1 < 0){
				this.velocity_y *= -1;
				
			}
		}
	}
	
	var ball = new Ball(70,75,120,125,1,1,2.2)
	
	// multiplayer aspect
	
	get(ref(database,"playerCount")).then((snapshit)=>{
		logInPlayerCount = snapshit.val() + 1;
		if (logInPlayerCount == null){
			logInPlayerCount = 1;
		}
		set(ref(database,"playerCount"),logInPlayerCount);
		console.log("increase");
	});
	
//	window.addEventListener("beforeunload", function(e){
	
	document.addEventListener("visibilitychange",()=>{
		if (document.visibilityState == "hidden"){
			get(ref(database,"playerCount")).then((snapshit)=>{
				logInPlayerCount = snapshit.val() - 1;
				set(ref(database,"playerCount"),logInPlayerCount);
			});
		}else{
			get(ref(database,"playerCount")).then((snapshit)=>{
				logInPlayerCount = snapshit.val() + 1;
				if (logInPlayerCount == null){
					logInPlayerCount = 1;
				}
				set(ref(database,"playerCount"),logInPlayerCount);
			});
		}
	});
	
	var gameState = {
		"mainPlayerCoords" : {
			x : "",
			y : ""
		},
		"enemyPlayerCoords" : {
			x : "",
			y : ""
		},
		"ballCoords" : {
			x : "",
			y : ""
		}
	};
	//console.log(gameState.mainPlayerCoords.x);
  </script>
  <title>pongGame</title>
</head>
<body>
	<div class="container">
		<div class="panel">
			<b>Your In Room : Public</b>
		</div>
		<canvas class="canvas"></canvas>
		<div class="joystickBig">
		</div>
		<div class="joystickSmall">
		</div>
	</div>
	<div class="chatSlider isHidden">
		<div class="chattingWrapper">
			<!--<div class="myChatBoxWrapper">
					<p class="myChatBox"> Name: <br/>
						test tes testes testes how u do now pensi</p>
			</div>>-->
		</div>
		<div class="inputWrapper">
			<input type="text" class="typeText" placeholder="Type Message Here"></input>
			<div class="sendText">Send</div>
		</div>
	</div>
	<div class="chatIcon">
		<i class="far fa-comment-dots fa-2x"></i>
	</div>
	<div class="startScreen">
		<div class="gameIcon">
			Pong Party
		</div>
		<div class="nameWrapper">
			<input class="typeName" type="text" placeholder="Input Your Name">
			</input>
			<div class="submitName">
				<i class="fas fa-table-tennis fa-2x"></i>
			</div>
		</div>
		<div class="codeWrapper">
			<input class="gameRoom" type="number" placeholder="Insert Room Code" oninput="javascript: if (this.value.length > 5) this.value = this.value.slice(0, 5);" ></input>
		</div>
		<div class="codeBtnWrapper">
			<button class="joinRoomBtn">Join Room</button>
			<button class="createRoomBtn">Create New Room</button>
		</div>
		<p class="version">V1.0</p>
	</div>
</body>
</html>
